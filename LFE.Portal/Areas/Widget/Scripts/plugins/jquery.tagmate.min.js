var Tagmate=function(){var n="\\w+",t="\\w+(?: \\w+)*",i="(?:(?:\\d{1,3}(?:\\,\\d{3})+)|(?:\\d+))(?:\\.\\d{2})?";return{HASH_TAG_EXPR:n,NAME_TAG_EXPR:t,PRICE_TAG_EXPR:i,DEFAULT_EXPRS:{"@":t,"#":n,$:i},filterOptions:function(n,t){for(var r,u,f=[],i=0;i<n.length;i++)r=n[i].label.toLowerCase(),u=t.toLowerCase(),u.length<=r.length&&r.indexOf(u)==0&&f.push(n[i]);return f}}}();(function(n){function r(n,t,i){var r=n.substring(i||0).search(t);return r>=0?r+(i||0):r}function t(n){return n.replace(/[-[\]{}()*+?.,\\^$|#\s]/g,"\\$&")}function i(n,i,u){var s={},h,e,a,v,l,y;for(tok in i)if(u&&u[tok]){h={};e={};for(key in u[tok])for(var p=u[tok][key].value,o=u[tok][key].label,c=t(tok+o),w=["(?:^(",")$|^(",")\\W|\\W(",")\\W|\\W(",")$)"].join(c),f=0,l=new RegExp(w,"gm");(f=r(n.val(),l,f))>-1;)a=e[f]?e[f]:null,(!a||h[a].length<o.length)&&(e[f]=p),h[p]=o,f+=o.length+1;for(f in e)s[tok+e[f]]=tok}else for(v=null,l=new RegExp("(["+tok+"]"+i[tok]+")","gm");v=l.exec(n.val());)s[v[1]]=tok;y=[];for(c in s)y.push(c);return y}n.fn.extend({getTags:function(t,r){var u=n(this);return t=t||u.data("_tagmate_exprs"),r=r||u.data("_tagmate_sources"),i(u,t,r)},tagmate:function(r){function f(n,t,i){for(var r=new RegExp("["+t+"]");i>=0&&!r.test(n[i]);i--);return i}function e(n){var o=n.val(),s=n.getSelection(),i=-1,t=null,r,e,h;for(tok in u.exprs)r=f(o,tok,s.start),r>i&&(i=r,t=tok);return(e=o.substring(i+1,s.start),h=new RegExp("^["+t+"]"+u.exprs[t]),h.exec(t+e))?t+e:null}function o(n,t,i){var r=n.val(),s=n.getSelection(),e=f(r,t[0],s.start),h=r.substr(0,e),c=r.substr(e+t.length),o;n.val(h+t[0]+i+c);o=e+i.length+1;n.setSelection(o,o);u.replace_tag&&u.replace_tag(t,i)}function h(n,t){var i,r,f;for(t=t.sort(function(n,t){var i=n.label.toLowerCase(),r=t.label.toLowerCase();return i>r?1:i<r?-1:0}),i=0;i<t.length;i++){var e=t[i].label,s=t[i].value,o=t[i].image;i==0&&n.html("");r="<span>"+e+"<\/span>";o&&(r="<img src='"+o+"' alt='"+e+"'/>"+r);f=u.menu_option_class;i==0&&(f+=" "+u.menu_option_active_class);n.append("<div class='"+f+"'>"+r+"<\/div>")}}function s(t,i){var h=i=="down"?":first-child":":last-child",s=i=="down"?"next":"prev",r=t.children("."+u.menu_option_active_class),f,e,o;for(r.length==0?(r=t.children(h),r.addClass(u.menu_option_active_class)):(r.removeClass(u.menu_option_active_class),r=r[s]().length>0?r[s]():r,r.addClass(u.menu_option_active_class)),e=t.children(),o=Math.floor(n(t).height()/n(e[0]).height())-1,n(t).height()%n(e[0]).height()>0&&(o-=1),f=0;f<e.length&&n(e[f]).html()!=n(r).html();f++);f>o&&f-o>=0&&f-o<e.length&&t.scrollTo(e[f-o])}function c(t){t.css("background","transparent");var r=n(t).wrap("<div class='tagmate-container'/>"),i=n("<span class='pre tagmate-hiliter'><\/span>");return t.before(i),t.css("margin-top","-"+t.outerHeight()+"px"),i}function l(n,r){for(var h,a,v,y,c=n.val(),f=n.data("_tagmate_sources"),o=i(n,u.exprs,f),e=0;e<o.length;e++){var l=o[e],s=o[e][0],p=o[e].substr(1);if(f&&f[s])for(h=0;h<f[s].length;h++)if(a=f[s][h],a.value==p){l=s+a.label;break}v=new RegExp(t(l),"g");y="<span class='"+u.highlight_class+"'>"+l+"<\/span>";c=c.replace(v,y)}r.html(c)}var u={exprs:Tagmate.DEFAULT_EXPRS,sources:null,capture_tag:null,replace_tag:null,menu_class:"tagmate-menu",menu_option_class:"tagmate-menu-option",menu_option_active_class:"tagmate-menu-option-active",highlight_tags:!1,highlight_class:"tagmate-highlight"};return this.each(function(){function p(){var o;if(i.hide(),o=e(t),o){var r=o[0],s=o.substr(1),c=t.getSelection(),l=f(t.val(),r,c.start);c.start-l<=o.length&&function(t){typeof u.sources[r]=="object"?t(Tagmate.filterOptions(u.sources[r],s)):typeof u.sources[r]=="function"?u.sources[r]({term:s},t):typeof u.sources[r]=="string"?n.getJSON(u.sources[r],{term:s},function(n){t(n.options)}):t()}(function(n){var e,f,s,c;if(n&&n.length>0)for(h(i,n),i.css("top",t.outerHeight()-1+"px"),i.show(),e=t.data("_tagmate_sources"),f=0;f<n.length;f++){for(s=!1,c=0;!s&&c<e[r].length;c++)s=e[r][c].value==n[f].value;s||e[r].push(n[f])}o&&u.capture_tag&&u.capture_tag(o)})}}var t,v,y,w,i,b,a;r&&n.extend(u,r);t=n(this);v=null;u.highlight_tags&&(v=c(t));t.data("_tagmate_exprs",u.exprs);y={};for(w in u.sources)y[w]=[];t.data("_tagmate_sources",y);i=n("<div class="+u.menu_class+"><\/div>");t.after(i);b=t.offset();i.css("position","absolute");i.hide();a=!1;n(t).unbind(".tagmate").bind("focus.tagmate",function(){p()}).bind("blur.tagmate",function(){setTimeout(function(){i.hide()},300)}).bind("click.tagmate",function(){p()}).bind("keydown.tagmate",function(n){if(i.is(":visible")){if(n.keyCode==40)return s(i,"down"),a=!0,!1;if(n.keyCode==38)return s(i,"up"),a=!0,!1;if(n.keyCode==13){var r=i.children("."+u.menu_option_active_class).text(),f=e(t);if(f&&r)return o(t,f,r),i.hide(),a=!0,window.userSelected=!0,setTimeout(function(){window.userSelected=!1},5),!1}else if(n.keyCode==27)return i.hide(),a=!0,!1}}).bind("keyup.tagmate",function(){if(a)return a=!1,!0;p();v&&l(t,v)});n("."+u.menu_class+" ."+u.menu_option_class).die("click.tagmate").live("click.tagmate",function(){var i=n(this).text(),r=e(t);o(t,r,i);t.keyup()})})}})})(jQuery);